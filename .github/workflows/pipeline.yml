name: SSDLC CI/CD Pipeline for Password Analyzer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Scan for secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_CONFIG: |
            title = "Gitleaks Config"
            
            [[rules]]
            id = "ignore-password-examples"
            description = "Ignore password examples in comments"
            regex = '''password.*['"].*['"]'''
            tags = ["skip"]
            
            [[rules]]
            id = "general-secrets"
            description = "General secrets detection"
            regex = '''(?i)(secret|key|token|password|credential)[^a-zA-Z0-9][a-zA-Z0-9]{20,}'''
            entropy = 3.5

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gitleaks-results
          path: results.sarif

  quality-analysis:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: security-analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: HTML Validation
        uses: validator/validator@v1.3.0
        with:
          ignore: 'CSS'

      - name: ESLint
        uses: stefanoeb/eslint-action@v1
        with:
          files: script.js

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            https://mmmykoladiploma.github.io/Password-Analyzer/
          uploadArtifacts: true
          temporaryPublicStorage: true

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [security-analysis, quality-analysis]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify files
        run: |
          [ -f index.html ] || exit 1
          [ -f style.css ] || exit 1
          [ -f script.js ] || exit 1

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: './'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2